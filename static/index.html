<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini RAG Enterprise</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #f9fafb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const storageKey = "userApiKey";
        const storageEmailKey = "userEmail";

        // Helper to determine API URL
        // If served via FastAPI (http), use relative paths. 
        // If opened as file/blob, point to localhost:8000.
        const getApiUrl = (endpoint) => {
            let base = "";
            if (window.location.protocol === 'file:' || window.location.protocol === 'blob:' || window.location.hostname === '') {
                base = "http://localhost:8000";
            }
            return `${base}${endpoint}`;
        };

        const AuthScreen = ({ setApiKey, setUserEmail }) => {
            const [mode, setMode] = useState("login");
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const submit = async () => {
                setError("");
                const endpoint = mode === "login" ? "/api/login" : "/api/register";
                try {
                    const res = await fetch(getApiUrl(endpoint), {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.detail || "Request failed");
                    localStorage.setItem(storageKey, data.api_key);
                    localStorage.setItem(storageEmailKey, data.email);
                    setApiKey(data.api_key);
                    setUserEmail(data.email);
                } catch (err) {
                    setError(err.message || "Auth failed");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="w-full max-w-md bg-white border border-gray-200 rounded-2xl shadow-sm p-8 space-y-4">
                        <h1 className="text-2xl font-bold text-gray-900 text-center">MCP RAG Access</h1>
                        <div className="flex gap-2 text-sm">
                            <button onClick={() => setMode("login")} className={`flex-1 py-2 rounded-lg ${mode === "login" ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-600"}`}>Login</button>
                            <button onClick={() => setMode("register")} className={`flex-1 py-2 rounded-lg ${mode === "register" ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-600"}`}>Register</button>
                        </div>
                        <div className="space-y-3">
                            <input className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} />
                            <input className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} />
                        </div>
                        {error && <div className="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2">{error}</div>}
                        <button onClick={submit} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-sm font-semibold">{mode === "login" ? "Login" : "Create account"}</button>
                    </div>
                </div>
            );
        };

        // --- ICONS COMPONENT HELPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const NotificationPopup = ({ data, onClose }) => {
            if (!data) return null;
            const toneStyles = {
                success: "border-green-200 bg-green-50 text-green-800",
                error: "border-red-200 bg-red-50 text-red-800",
                warning: "border-amber-200 bg-amber-50 text-amber-800",
                info: "border-blue-200 bg-blue-50 text-blue-800",
            };
            return (
                <div className="fixed bottom-6 right-6 z-[70] shadow-lg">
                    <div className={`w-80 border rounded-xl px-4 py-3 flex items-start gap-3 ${toneStyles[data.tone] || toneStyles.info}`}>
                        <div className="mt-1">
                            <Icon name={data.tone === 'error' ? 'alert-circle' : data.tone === 'warning' ? 'alert-triangle' : 'check-circle'} size={18} />
                        </div>
                        <div className="flex-1">
                            <div className="font-semibold text-sm">{data.title}</div>
                            {data.message && <div className="text-xs leading-relaxed mt-1">{data.message}</div>}
                        </div>
                        <button className="text-gray-500 hover:text-gray-700" onClick={onClose}>
                            <Icon name="x" size={16} />
                        </button>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ dialog, onConfirm, onCancel }) => {
            if (!dialog) return null;
            return (
                <div className="fixed inset-0 bg-black/40 z-[80] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full border border-gray-200">
                        <div className="p-4 border-b border-gray-100 flex items-center gap-2">
                            <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600">
                                <Icon name="info" size={18} />
                            </div>
                            <div>
                                <div className="font-semibold text-gray-900">{dialog.title}</div>
                                {dialog.subtitle && <div className="text-xs text-gray-600">{dialog.subtitle}</div>}
                            </div>
                        </div>
                        <div className="p-4 text-sm text-gray-700 leading-relaxed">{dialog.message}</div>
                        <div className="p-4 border-t border-gray-100 flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm shadow">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PromptDialog = ({ dialog, value, onChange, onSubmit, onCancel }) => {
            if (!dialog) return null;
            return (
                <div className="fixed inset-0 bg-black/40 z-[80] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full border border-gray-200">
                        <div className="p-4 border-b border-gray-100">
                            <div className="font-semibold text-gray-900">{dialog.title}</div>
                            {dialog.message && <div className="text-xs text-gray-600 mt-1">{dialog.message}</div>}
                        </div>
                        <div className="p-4 space-y-2">
                            <label className="text-xs font-semibold text-gray-600">Name</label>
                            <input
                                className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                value={value}
                                onChange={(e) => onChange(e.target.value)}
                            />
                        </div>
                        <div className="p-4 border-t border-gray-100 flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm">Cancel</button>
                            <button onClick={onSubmit} className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm shadow">Save</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('dashboard'); // dashboard | ingest
            const [knowledgeBases, setKnowledgeBases] = useState([]);
            const [activeKnowledgeBase, setActiveKnowledgeBase] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");
            const [apiKey, setApiKey] = useState(localStorage.getItem(storageKey) || "");
            const [userEmail, setUserEmail] = useState(localStorage.getItem(storageEmailKey) || "");
            const [metrics, setMetrics] = useState(null);
            const supportedFormats = [
                'PDF (.pdf)',
                'Word (.docx)',
                'PowerPoint (.pptx)',
                'Excel (.xlsx)',
                'Markdown (.md)',
                'Text (.txt)',
                'HTML (.html)',
                'CSV (.csv)',
                'JSON (.json)'
            ];
            const maxUploadMb = 2;
            const [notification, setNotification] = useState(null);
            const [confirmDialog, setConfirmDialog] = useState(null);
            const [promptDialog, setPromptDialog] = useState(null);
            const [promptValue, setPromptValue] = useState("");

            const showNotification = (title, message = "", tone = "success") => {
                setNotification({ title, message, tone });
                setTimeout(() => setNotification(null), 3200);
            };

            const requestConfirm = (payload) => new Promise((resolve) => {
                setConfirmDialog({ ...payload, resolve });
            });

            const requestPrompt = (payload) => new Promise((resolve) => {
                setPromptValue(payload.defaultValue || "");
                setPromptDialog({ ...payload, resolve });
            });

            const fetchKnowledgeBases = async () => {
                if (!apiKey) return;
                setLoading(true);
                setError("");
                try {
                    const res = await fetch(getApiUrl('/api/knowledge-bases'), {
                        headers: { Authorization: `Bearer ${apiKey}` }
                    });
                    if (!res.ok) throw new Error("Failed to fetch knowledge bases");
                    const data = await res.json();
                    setKnowledgeBases(data);
                } catch (err) {
                    console.error(err);
                    setError("Unable to load knowledge bases. Please ensure the backend is running.");
                } finally {
                    setLoading(false);
                }
            };

            const fetchMetrics = async () => {
                if (!apiKey) return;
                try {
                    const res = await fetch(getApiUrl('/api/metrics'), { headers: { Authorization: `Bearer ${apiKey}` } });
                    if (!res.ok) throw new Error("Failed to load metrics");
                    const data = await res.json();
                    setMetrics(data);
                } catch (err) {
                    console.error(err);
                }
            };

            // Fetch knowledge bases on load
            useEffect(() => {
                if (apiKey) { fetchKnowledgeBases(); fetchMetrics(); }
            }, [apiKey]);

            const selectKnowledgeBase = (kb) => {
                setActiveKnowledgeBase(kb);
                setView('ingest');
            };

            const deleteKnowledgeBase = async (knowledgeBaseId) => {
                if (!knowledgeBaseId) return;
                const confirmed = await requestConfirm({
                    title: "Delete knowledge base",
                    message: "This will remove the knowledge base and all indexed documents.",
                });
                if (!confirmed) return;
                setError("");
                setLoading(true);
                try {
                    const res = await fetch(getApiUrl(`/api/knowledge-base/${knowledgeBaseId}`), { method: 'DELETE', headers: { Authorization: `Bearer ${apiKey}` } });
                    if (!res.ok) throw new Error("Failed to delete knowledge base");
                    await fetchKnowledgeBases();
                    showNotification("Knowledge base deleted", "The knowledge base and its documents were removed.", "success");
                } catch (err) {
                    console.error(err);
                    setError("Unable to delete knowledge base. Please try again.");
                } finally {
                    setLoading(false);
                }
            };

            const copyKnowledgeBase = async (knowledgeBaseId, name) => {
                try {
                    const newName = await requestPrompt({
                        title: "Copy knowledge base",
                        message: "Provide a name for the duplicated knowledge base.",
                        defaultValue: `${name} (Copy)`,
                    });
                    if (!newName) return;
                    const res = await fetch(getApiUrl(`/api/knowledge-base/${knowledgeBaseId}/copy`), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                        body: JSON.stringify({ name: newName, include_docs: true })
                    });
                    if (!res.ok) throw new Error("Copy failed");
                    showNotification("Knowledge base copied", `${newName} is ready to use.`, "success");
                    fetchKnowledgeBases();
                } catch (err) {
                    console.error(err);
                    showNotification("Copy failed", "Could not copy knowledge base.", "error");
                }
            };

            const default_system_prompt = `You are a Retrieval-Augmented Generation (RAG) assistant.

Your only job is to answer user questions using the retrieved context provided to you. Do not rely on outside knowledge. If the documents do not contain the answer, say clearly: "The documents do not contain enough information to answer this question."

Rules:
1. Use only information found in the retrieved context.
2. Do not guess or hallucinate.
3. Summaries must strictly follow the documents.
4. If the user asks for unsupported information, state that it is unavailable.
5. Respond in plain text unless structured output is requested.
`

            const createNew = () => {
                setActiveKnowledgeBase({
                    name: "New Knowledge Base",
                    system_prompt: default_system_prompt,
                    chunk_size: 1000,
                    overlap: 200,
                    chunking_method: "fixed",
                    embedding_dimensions: 768,
                    top_k: 5
                });
                setView('ingest');
            };

            if (!apiKey) {
                return <AuthScreen setApiKey={setApiKey} setUserEmail={setUserEmail} />;
            }

            return (
                <div className="min-h-screen text-gray-800">
                    {/* Navigation */}
                    <nav className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <a href="/">
                                <span className="text-xl font-bold tracking-tight">MCP RAG</span>
                            </a>
                        </div>
                        <div className="flex items-center gap-4 text-sm">
                            <div className="text-right">
                                <div className="text-gray-600 mb-1">Logged in as {userEmail || "User"}</div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-gray-500">API Key:</span>
                                    <code className="text-xs bg-gray-100 px-2 py-1 rounded font-mono text-gray-700">{apiKey ? apiKey.substring(0, 20) + '...' : ''}</code>
                                    <button
                                        onClick={() => {
                                            navigator.clipboard.writeText(apiKey);
                                            showNotification('API key copied', 'Your key is ready to use.', 'success');
                                        }}
                                        className="text-xs text-blue-600 hover:text-blue-800 underline"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                            <button className="text-blue-600 hover:text-blue-800" onClick={() => { localStorage.removeItem(storageKey); localStorage.removeItem(storageEmailKey); setApiKey(""); setUserEmail(""); }}>Logout</button>
                        </div>
                    </nav>

                    {view === 'dashboard' ? (
                        <Dashboard
                            knowledgeBases={knowledgeBases}
                            loading={loading}
                            error={error}
                            onCreate={createNew}
                            onSelect={selectKnowledgeBase}
                            onDelete={deleteKnowledgeBase}
                            onCopy={copyKnowledgeBase}
                            metrics={metrics}
                        />
                    ) : (
                        <IngestScreen
                            knowledgeBase={activeKnowledgeBase}
                            onBack={() => {
                                setView('dashboard');
                                fetchKnowledgeBases();
                            }}
                            refreshKnowledgeBases={fetchKnowledgeBases}
                            apiKey={apiKey}
                            notify={showNotification}
                            confirmAction={requestConfirm}
                            supportedFormats={supportedFormats}
                            maxUploadMb={maxUploadMb}
                        />
                    )}
                    <NotificationPopup data={notification} onClose={() => setNotification(null)} />
                    <ConfirmDialog
                        dialog={confirmDialog}
                        onConfirm={() => { confirmDialog?.resolve(true); setConfirmDialog(null); }}
                        onCancel={() => { confirmDialog?.resolve(false); setConfirmDialog(null); }}
                    />
                    <PromptDialog
                        dialog={promptDialog}
                        value={promptValue}
                        onChange={setPromptValue}
                        onSubmit={() => { promptDialog?.resolve(promptValue); setPromptDialog(null); }}
                        onCancel={() => { promptDialog?.resolve(null); setPromptDialog(null); }}
                    />
                </div>
            );
        };

        // --- DASHBOARD COMPONENT ---
        const Dashboard = ({ knowledgeBases, loading, error, onCreate, onSelect, onDelete, onCopy, metrics }) => {
            return (
                <div className="max-w-6xl mx-auto p-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-end mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900">Knowledge Bases</h1>
                            <p className="text-gray-500 mt-2">Manage your knowledge bases and AI personas</p>
                        </div>
                        <button onClick={onCreate} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center gap-2">
                            <Icon name="plus" size={18} /> Create New
                        </button>
                    </div>

	                    {metrics && (
	                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
	                            <div className="bg-white border border-gray-200 rounded-xl p-4">
	                                <div className="text-xs uppercase text-gray-500">Total Knowledge Bases</div>
	                                <div className="text-2xl font-bold text-gray-900">{metrics.knowledge_bases_count ?? metrics.assistants_count}</div>
	                            </div>
                            <div className="bg-white border border-gray-200 rounded-xl p-4">
                                <div className="text-xs uppercase text-gray-500">Documents</div>
                                <div className="text-2xl font-bold text-gray-900">{metrics.documents_count}</div>
                            </div>
                            <div className="bg-white border border-gray-200 rounded-xl p-4">
                                <div className="text-xs uppercase text-gray-500">Users</div>
                                <div className="text-2xl font-bold text-gray-900">{metrics.total_users}</div>
                            </div>
                        </div>
                    )}

                    {error && <div className="mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">{error}</div>}

                    {loading ? (
                        <div className="text-gray-500">Loading knowledge bases...</div>
                    ) : knowledgeBases.length === 0 ? (
                        <div className="bg-white border-2 border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-400">
                            <div className="mx-auto w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"><Icon name="bot" size={24} /></div>
                            <p>No knowledge bases found. Click "Create New" to add one.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {knowledgeBases.map((kb, idx) => {
                                const summary = (metrics?.knowledge_bases || metrics?.assistants)?.find(a => a.id === kb.id);
                                return (
                                    <div key={idx} onClick={() => onSelect(kb)} className="bg-white p-6 rounded-2xl border border-gray-200 hover:border-blue-400 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                                                <Icon name="bot" size={24} />
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="bg-gray-100 text-gray-600 text-xs font-medium px-2 py-1 rounded-full">
                                                    ID: {kb.id ? kb.id.slice(-4) : 'NEW'}
                                                </span>
                                                {kb.secure_enabled && (
                                                    <span className="bg-amber-100 text-amber-700 text-[11px] font-semibold px-2 py-1 rounded-full">Secure</span>
                                                )}
                                                {kb.id && (
	                                                    <button
	                                                        onClick={(e) => { e.stopPropagation(); onCopy(kb.id, kb.name); }}
	                                                        className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
	                                                        title="Copy knowledge base"
	                                                    >
                                                        <Icon name="copy" size={16} />
                                                    </button>
                                                )}
                                                {kb.id && (
	                                                    <button
	                                                        onClick={(e) => { e.stopPropagation(); onDelete(kb.id); }}
	                                                        className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
	                                                        title="Delete knowledge base"
	                                                    >
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-lg text-gray-900 mb-2">{kb.name}</h3>
                                        <p className="text-sm text-gray-500 line-clamp-2 mb-4 h-10">{kb.system_prompt}</p>
                                        <div className="border-t border-gray-100 pt-4 flex gap-4 text-xs text-gray-400 justify-between items-center">
                                            <span className="flex items-center gap-1"><Icon name="layers" size={14} /> {kb.chunk_size} chars</span>
                                            <span className="flex items-center gap-1"><Icon name="list" size={14} /> Top {kb.top_k}</span>
                                            {summary && <span className="flex items-center gap-1 text-gray-600"><Icon name="file-text" size={14} /> {summary.documents} docs</span>}
	                                            <button
	                                                onClick={(e) => { e.stopPropagation(); window.open(`/static/chat.html?knowledgeBaseId=${kb.id}`, '_blank'); }}
	                                                className="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1"
	                                            >
                                                <Icon name="share" size={14} /> Share chat
                                            </button>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- INGEST SCREEN COMPONENT ---

        const IngestScreen = ({ knowledgeBase, onBack, refreshKnowledgeBases, apiKey, notify, confirmAction, supportedFormats, maxUploadMb }) => {
            const buildDefaultConfig = (baseKnowledgeBase = null) => {
                const base = baseKnowledgeBase || knowledgeBase || {};
                const default_system_prompt = `You are a Retrieval-Augmented Generation (RAG) assistant.

Your only job is to answer user questions using the retrieved context provided to you. Do not rely on outside knowledge. If the documents do not contain the answer, say clearly: "The documents do not contain enough information to answer this question."

Rules:
1. Use only information found in the retrieved context.
2. Do not guess or hallucinate.
3. Summaries must strictly follow the documents.
4. If the user asks for unsupported information, state that it is unavailable.
5. Respond in plain text unless structured output is requested.
`
                return {
                    name: base.name || "New Knowledge Base",
                    system_prompt: base.system_prompt || default_system_prompt,
                    chunk_size: base.chunk_size || 1000,
                    overlap: base.overlap || 200,
                    chunking_method: base.chunking_method || "fixed",
                    embedding_dimensions: base.embedding_dimensions || 768,
                    top_k: base.top_k || 5,
                    hyde_enabled: base.hyde_enabled ?? false,
                    reranker_enabled: base.reranker_enabled ?? false,
                    reranker_model: base.reranker_model || "",
                    reranker_top_n: base.reranker_top_n ?? 3,
                    id: base.id,
                    secure_enabled: base.secure_enabled ?? false,
                    credentials: base.credentials || [],
                    api_key: base.api_key || ""
                };
            };

            const [config, setConfig] = useState(buildDefaultConfig());
            const [docs, setDocs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showChat, setShowChat] = useState(false);
            const [error, setError] = useState("");
            const [uploadMessage, setUploadMessage] = useState("");
            const [chatSize, setChatSize] = useState({ width: 480, height: 560 });
            const minChatSize = { width: 384, height: 500 };
            const [isMaximized, setIsMaximized] = useState(false);
            const [prevChatSize, setPrevChatSize] = useState(null);
            const [newCredential, setNewCredential] = useState({ email: "", password: "" });
            const [showCredentialModal, setShowCredentialModal] = useState(false);
            const [credentialPage, setCredentialPage] = useState(0);
            const credentialsPerPage = 5;
            const acceptedFileTypes = '.pdf,.docx,.pptx,.xlsx,.md,.txt,.html,.htm,.csv,.json';
            const embeddingDimensionOptions = [768];
            const chunkingMethods = [
                {
                    id: "fixed",
                    label: "Fixed Chunking",
                    pros: ["Simple", "Fast", "Predictable"],
                    cons: ["May break sentences"],
                    best_uses: ["Quick prototyping"]
                },
                {
                    id: "overlapping",
                    label: "Overlapping Chunking",
                    pros: ["Maintains context flow", "Prevents information loss"],
                    cons: ["More storage", "Potential redundancy"],
                    best_uses: ["Q&A systems", "RAG pipelines"],
                    note: "Recommended overlap: 20-25 percent"
                },
                {
                    id: "semantic",
                    label: "Semantic Chunking",
                    pros: ["Respects sentence boundaries", "Maintains meaning"],
                    cons: ["Requires NLP libraries", "Slower than fixed chunking"],
                    best_uses: ["Chatbots", "Content summarization"]
                },
                {
                    id: "recursive_character",
                    label: "Recursive Character Chunking",
                    pros: ["Avoids word splitting", "Finds nearest space"],
                    cons: ["Recursive overhead", "Variable chunk sizes"],
                    best_uses: ["Token limit handling", "Precise character control"]
                },
                {
                    id: "agentic",
                    label: "Agentic Chunking",
                    pros: ["Task aware", "Highly adaptive"],
                    cons: ["Requires API calls", "Slower", "Internet dependent"],
                    best_uses: ["High value documents", "Task specific chunking"]
                },
                {
                    id: "advanced_semantic",
                    label: "Advanced Semantic Chunking",
                    pros: ["ML powered semantic grouping", "Excellent topic clustering"],
                    cons: ["Requires ML libraries", "Slower processing"],
                    best_uses: ["Topic clustering", "Advanced semantic analysis"]
                },
                {
                    id: "context_enriched",
                    label: "Context Enriched Chunking",
                    pros: ["Rich context", "Better understanding"],
                    cons: ["Larger chunks", "More storage usage"],
                    best_uses: ["Context heavy Q&A systems"]
                },
                {
                    id: "paragraph",
                    label: "Paragraph Chunking",
                    pros: ["Preserves document structure", "Respects author intent"],
                    cons: ["Variable chunk sizes", "Requires proper formatting"],
                    best_uses: ["Articles", "Reports", "Documentation"]
                },
                {
                    id: "recursive_sentence",
                    label: "Recursive Sentence Chunking",
                    pros: ["Balanced structure", "Sentence aware"],
                    cons: ["Recursive overhead", "Assumes clear sentence boundaries"],
                    best_uses: ["Narrative text", "Stories"]
                },
                {
                    id: "token_based",
                    label: "Token Based Chunking",
                    pros: ["Precise token control", "Cost optimization"],
                    cons: ["May break sentences", "Requires proper tokenizer"],
                    best_uses: ["API token limits", "Cost optimization"]
                }
            ];
            const [chunkingDropdownOpen, setChunkingDropdownOpen] = useState(false);
            const [hoveredChunkingId, setHoveredChunkingId] = useState(null);
            const chunkingMenuRef = useRef(null);
            const selectedChunkingMethod = chunkingMethods.find((method) => method.id === config.chunking_method) || chunkingMethods[0];
            const hoveredChunkingMethod = chunkingMethods.find((method) => method.id === hoveredChunkingId);

            // Editor State
            const [editorOpen, setEditorOpen] = useState(false);
            const [editDocData, setEditDocData] = useState(null); // { id, text }

            useEffect(() => {
                const nextConfig = buildDefaultConfig();
                setConfig(nextConfig);
                setDocs([]);
            }, [knowledgeBase]);

            useEffect(() => {
                if (config?.id) fetchDocs(config.id);
            }, [config.id]);

            useEffect(() => {
                if (!chunkingDropdownOpen) return;
                const handleClickOutside = (event) => {
                    if (chunkingMenuRef.current && !chunkingMenuRef.current.contains(event.target)) {
                        setChunkingDropdownOpen(false);
                        setHoveredChunkingId(null);
                    }
                };
                window.addEventListener("mousedown", handleClickOutside);
                return () => window.removeEventListener("mousedown", handleClickOutside);
            }, [chunkingDropdownOpen]);

	            const fetchDocs = async (id) => {
	                if (!id) return;
	                setError("");
	                try {
	                    const res = await fetch(getApiUrl(`/api/knowledge-base/${id}/documents`), { headers: { Authorization: `Bearer ${apiKey}` } });
	                    if (!res.ok) throw new Error("Failed to fetch documents");
	                    const data = await res.json();
	                    setDocs(data);
	                } catch (err) {
	                    console.error(err);
	                    setError("Unable to load documents. Please try again.");
	                }
	            };

            const saveConfig = async () => {
                setError("");
                try {
                    if (!config.id) {
                        const confirmed = await confirmAction({
                            title: "Lock embedding dimensions",
                            message: `Gemini embeddings use ${config.embedding_dimensions} dimensions. This cannot be changed after saving. Continue?`,
                        });
                        if (!confirmed) return;
                    }
                    const res = await fetch(getApiUrl('/api/knowledge-base'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                        body: JSON.stringify(config)
                    });
                    if (!res.ok) throw new Error("Failed to save knowledge base");
                    const data = await res.json();
                    if (data.id) setConfig({ ...config, id: data.id });
                    await refreshKnowledgeBases();
	                    const updatedRes = await fetch(getApiUrl('/api/knowledge-bases'), {
	                        headers: { Authorization: `Bearer ${apiKey}` }
	                    });
                    if (updatedRes.ok) {
                        const updatedList = await updatedRes.json();
                        if (Array.isArray(updatedList)) {
                            const fresh = updatedList.find(a => a.id === (config.id || data.id));
                            if (fresh) setConfig(buildDefaultConfig({ ...fresh }));
                        }
                    }
                    notify("Configuration saved", "Your knowledge base settings have been stored.", "success");
                } catch (err) {
                    console.error(err);
                    setError("Could not save configuration. Please check the backend.");
                }
            };

                    const uploadFile = async (e) => {
                        if (!config.id) {
                            notify("Save required", "Please save the knowledge base before uploading documents.", "warning");
                            return;
                        }
                        const file = e.target.files[0];
                        if (!file) return;
                        if (file.size > maxUploadMb * 1024 * 1024) {
                            notify("File too large", `Max size is ${maxUploadMb} MB.`, "warning");
                            e.target.value = "";
                            return;
                        }

                setLoading(true);
                setUploadMessage("Uploading and indexing...");
                setError("");

                const formData = new FormData();
                formData.append("file", file);

	                try {
	                    const res = await fetch(getApiUrl(`/api/knowledge-base/${config.id}/upload`), { method: 'POST', body: formData, headers: { Authorization: `Bearer ${apiKey}` } });
	                    if (!res.ok) throw new Error("Upload failed");
	                    await fetchDocs(config.id);
	                    setUploadMessage("Upload complete");
                } catch (err) {
                    console.error(err);
                    setError("Upload failed. Please ensure the backend is running and try again.");
                    setUploadMessage("");
                }
                setLoading(false);
                // Clear the file input so user can re-upload same file if needed
                e.target.value = "";
            };

            const deleteDoc = async (docId) => {
                const confirmed = await confirmAction({
                    title: "Delete document",
                    message: "This will remove the extracted text and vectors for this file.",
                });
                if (!confirmed) return;

                await fetch(getApiUrl(`/api/document/${docId}`), { method: 'DELETE', headers: { Authorization: `Bearer ${apiKey}` } });
                fetchDocs(config.id);
            };

            const reindexDoc = async (docId) => {
                const confirmed = await confirmAction({
                    title: "Reindex document",
                    message: "The document will be re-extracted and embeddings refreshed.",
                });
                if (!confirmed) return;
                setLoading(true);
                setError("");
                setUploadMessage("Reindexing...");
                try {
                    const res = await fetch(getApiUrl(`/api/document/${docId}/reindex`), { method: 'POST', headers: { Authorization: `Bearer ${apiKey}` } });
                    if (!res.ok) throw new Error("Reindex failed");
                    await fetchDocs(config.id);
                    setUploadMessage("Reindex complete");
                } catch (err) {
                    console.error(err);
                    setError("Reindex failed. Please try again.");
                    setUploadMessage("");
                }
                setLoading(false);
            };

            const openEditor = async (docId) => {
                const res = await fetch(getApiUrl(`/api/document/${docId}`), { headers: { Authorization: `Bearer ${apiKey}` } });
                const data = await res.json();
                setEditDocData(data);
                setEditorOpen(true);
            };

            const saveEditedText = async () => {
                await fetch(getApiUrl(`/api/document/${editDocData.id}`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    body: JSON.stringify({ extracted_text: editDocData.text })
                });
                setEditorOpen(false);
                notify("Document updated", "Text saved and vectors refreshed.", "success");
            };

            const startChatResize = (e) => {
                if (isMaximized) return;
                e.preventDefault();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = chatSize.width;
                const startHeight = chatSize.height;

                const onMouseMove = (ev) => {
                    const newWidth = Math.max(minChatSize.width, startWidth + (ev.clientX - startX));
                    const newHeight = Math.max(minChatSize.height, startHeight + (ev.clientY - startY));
                    setChatSize({ width: newWidth, height: newHeight });
                };

                const onMouseUp = () => {
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onMouseUp);
                };

                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
            };

            const toggleMaximize = () => {
                if (!isMaximized) {
                    setPrevChatSize(chatSize);
                    const maxWidth = Math.min(window.innerWidth - 32, 1100);
                    const maxHeight = Math.min(window.innerHeight - 80, 850);
                    setChatSize({
                        width: Math.max(minChatSize.width, maxWidth),
                        height: Math.max(minChatSize.height, maxHeight)
                    });
                    setIsMaximized(true);
                } else {
                    if (prevChatSize) setChatSize(prevChatSize);
                    setIsMaximized(false);
                }
            };

            const addCredential = () => {
                if (!newCredential.email || !newCredential.password) return;
                setConfig({
                    ...config,
                    credentials: [...(config.credentials || []), { ...newCredential }]
                });
                setNewCredential({ email: "", password: "" });
            };

            const removeCredential = (index) => {
                const next = [...(config.credentials || [])];
                next.splice(index, 1);
                setConfig({ ...config, credentials: next });
            };

            const regenerateApiKey = () => {
                const key = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
                setConfig({ ...config, api_key: key });
            };

            return (
                <div className="flex h-[calc(100vh-73px)] overflow-hidden">
                    {/* Sidebar Config */}
                    <div className="w-80 bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden">
                        <div className="p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                            <button onClick={onBack} className="text-gray-500 hover:text-blue-600 flex items-center gap-2 mb-4 text-sm font-medium">
                                <Icon name="arrow-left" size={16} /> Back to Dashboard
                            </button>
                            <div className="flex items-center justify-between gap-2">
                                <h2 className="font-bold text-gray-900">Settings</h2>
                                <span className="text-[11px] text-gray-500 bg-gray-100 rounded px-2 py-1">{config.id ? `ID: ${config.id}` : "Not saved"}</span>
                            </div>
                            {error && <div className="mt-3 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-xs">{error}</div>}
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Name</label>
                                <input className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={config.name} onChange={e => setConfig({ ...config, name: e.target.value })} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">System Prompt</label>
                                <textarea className="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                                    value={config.system_prompt} onChange={e => setConfig({ ...config, system_prompt: e.target.value })} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Chunk Size</label>
                                    <input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                                        value={config.chunk_size} onChange={e => setConfig({ ...config, chunk_size: parseInt(e.target.value) })} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Overlap</label>
                                    <input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                                        value={config.overlap} onChange={e => setConfig({ ...config, overlap: parseInt(e.target.value) })} />
                                </div>
                            </div>
                            <div className="space-y-2" ref={chunkingMenuRef}>
                                <label className="block text-xs font-bold text-gray-500 uppercase">Chunking Method</label>
                                <button
                                    type="button"
                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm flex items-center justify-between hover:border-blue-300"
                                    onClick={() => {
                                        const nextOpen = !chunkingDropdownOpen;
                                        setChunkingDropdownOpen(nextOpen);
                                        if (nextOpen) {
                                            setHoveredChunkingId(config.chunking_method || selectedChunkingMethod.id);
                                        }
                                    }}
                                >
                                    <div className="text-left">
                                        <div className="text-sm font-medium text-gray-800">{selectedChunkingMethod.label}</div>
                                        <div className="text-xs text-gray-500">{selectedChunkingMethod.best_uses.join(", ")}</div>
                                    </div>
                                    <Icon name={chunkingDropdownOpen ? "chevron-up" : "chevron-down"} size={16} />
                                </button>
                                {chunkingDropdownOpen && (
                                    <div className="relative">
                                        <div className="mt-2 bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden">
                                            {chunkingMethods.map((method) => (
                                                <button
                                                    key={method.id}
                                                    type="button"
                                                    onMouseEnter={() => setHoveredChunkingId(method.id)}
                                                    onMouseLeave={() => setHoveredChunkingId(null)}
                                                    onClick={() => {
                                                        setConfig({ ...config, chunking_method: method.id });
                                                        setChunkingDropdownOpen(false);
                                                        setHoveredChunkingId(null);
                                                    }}
                                                    className={`w-full text-left px-3 py-2 hover:bg-blue-50 ${config.chunking_method === method.id ? "bg-blue-50" : ""}`}
                                                >
                                                    <div className="text-sm font-medium text-gray-800">{method.label}</div>
                                                    <div className="text-[11px] text-gray-500">{method.best_uses.join(", ")}</div>
                                                </button>
                                            ))}
                                        </div>
                                        {hoveredChunkingMethod && (
                                            <div className="absolute left-full top-0 ml-3 w-72 bg-gray-900 text-white text-[11px] p-3 rounded-lg shadow-lg">
                                                <div className="text-sm font-semibold">{hoveredChunkingMethod.label}</div>
                                                {hoveredChunkingMethod.note && (
                                                    <div className="text-[11px] text-gray-300 mt-1">{hoveredChunkingMethod.note}</div>
                                                )}
                                                <div className="mt-2">
                                                    <div className="text-[10px] uppercase tracking-wide text-gray-400">Advantages</div>
                                                    <div className="text-[11px]">{hoveredChunkingMethod.pros.join(", ")}</div>
                                                </div>
                                                <div className="mt-2">
                                                    <div className="text-[10px] uppercase tracking-wide text-gray-400">Key drawback</div>
                                                    <div className="text-[11px]">{hoveredChunkingMethod.cons.join(", ")}</div>
                                                </div>
                                                <div className="mt-2">
                                                    <div className="text-[10px] uppercase tracking-wide text-gray-400">Best uses</div>
                                                    <div className="text-[11px]">{hoveredChunkingMethod.best_uses.join(", ")}</div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <p className="text-[11px] text-gray-500">Hover over an option to see advantages, key drawback, and best uses.</p>
                                <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-[11px] text-gray-600 space-y-1">
                                    <div className="text-[11px] text-gray-500">Selected method details</div>
                                    <div><span className="font-semibold text-gray-700">Advantages:</span> {selectedChunkingMethod.pros.join(", ")}</div>
                                    <div><span className="font-semibold text-gray-700">Key drawback:</span> {selectedChunkingMethod.cons.join(", ")}</div>
                                    <div><span className="font-semibold text-gray-700">Best uses:</span> {selectedChunkingMethod.best_uses.join(", ")}</div>
                                    {selectedChunkingMethod.note && (
                                        <div><span className="font-semibold text-gray-700">Note:</span> {selectedChunkingMethod.note}</div>
                                    )}
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Embedding Dimensions</label>
                                <select
                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm disabled:opacity-70"
                                    value={config.embedding_dimensions || embeddingDimensionOptions[0]}
                                    disabled={!!config.id}
                                    onChange={e => setConfig({ ...config, embedding_dimensions: parseInt(e.target.value) || embeddingDimensionOptions[0] })}
                                >
                                    {embeddingDimensionOptions.map((dimension) => (
                                        <option key={dimension} value={dimension}>{dimension}</option>
                                    ))}
                                </select>
                                <p className="text-[11px] text-gray-500 mt-1">Gemini embeddings return 768 dimensions. This value locks after the first save.</p>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Top K Results: {config.top_k}</label>
                                <input type="range" min="1" max="20" className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    value={config.top_k} onChange={e => setConfig({ ...config, top_k: parseInt(e.target.value) })} />
                            </div>
                            <div className="p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-2">
                                <label className="flex items-start gap-3 text-sm font-medium text-gray-800">
                                    <input
                                        type="checkbox"
                                        className="mt-1"
                                        checked={!!config.hyde_enabled}
                                        onChange={e => setConfig({ ...config, hyde_enabled: e.target.checked })}
                                    />
                                    <div>
                                        <div>HyDE retrieval</div>
                                        <p className="text-xs text-gray-500">Use a hypothetical answer from the LLM to drive embeddings and improve recall.</p>
                                    </div>
                                </label>
                            </div>
                            <div className="p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
                                <label className="flex items-start gap-3 text-sm font-medium text-gray-800">
                                    <input
                                        type="checkbox"
                                        className="mt-1"
                                        checked={!!config.reranker_enabled}
                                        onChange={e => setConfig({ ...config, reranker_enabled: e.target.checked })}
                                    />
                                    <div>
                                        <div>Reranker</div>
                                        <p className="text-xs text-gray-500">Re-rank retrieved chunks with a model and keep only the top matches.</p>
                                    </div>
                                </label>
                                {config.reranker_enabled && (
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Reranker Model</label>
                                            <input
                                                className="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={config.reranker_model}
                                                onChange={e => setConfig({ ...config, reranker_model: e.target.value })}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Keep Top Relevant</label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="50"
                                                className="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm"
                                                value={config.reranker_top_n}
                                                onChange={e => setConfig({ ...config, reranker_top_n: Math.max(1, parseInt(e.target.value) || 1) })}
                                            />
                                            <p className="text-[11px] text-gray-500 mt-1">Number of top-ranked chunks to pass to the final answer.</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
                                <div className="flex items-center justify-between">
                                    <label className="flex items-center gap-2 text-sm font-medium text-gray-800">
                                        <input type="checkbox" checked={!!config.secure_enabled} onChange={e => setConfig({ ...config, secure_enabled: e.target.checked })} />
                                        Secure access (email/password or API key)
                                    </label>
                                    {config.api_key && (
                                        <button onClick={() => navigator.clipboard.writeText(config.api_key)} className="text-xs text-blue-600 hover:text-blue-800">Copy API key</button>
                                    )}
                                </div>
                                {config.api_key && (
                                    <div className="text-xs text-gray-600 bg-white border border-dashed border-gray-200 rounded px-3 py-2 flex items-center justify-between">
                                        <span className="font-mono break-all">API Key: {config.api_key}</span>
                                        <button onClick={regenerateApiKey} className="text-blue-600 hover:text-blue-800 ml-2">Regenerate</button>
                                    </div>
                                )}
                                {config.secure_enabled && (
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between">
                                            <div className="text-xs text-gray-500">
                                                Allowed users: {(config.credentials || []).length}
                                            </div>
                                            <button
                                                onClick={() => setShowCredentialModal(true)}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 flex items-center gap-2"
                                            >
                                                <Icon name="users" size={16} />
                                                Manage Users
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Share Chat Link */}
	                            {config.id && (
	                                <div className="p-4 border border-blue-200 rounded-lg bg-blue-50 space-y-3">
                                    <div className="flex items-center gap-2 text-sm font-semibold text-blue-900">
                                        <Icon name="share-2" size={16} />
                                        Share Chat Link
                                    </div>
	                                    <p className="text-xs text-blue-700">
	                                        Share this link to let others chat with this knowledge base
	                                    </p>
                                    <div className="flex gap-2">
	                                        <input
	                                            readOnly
	                                            value={`${window.location.origin}/static/chat.html?knowledgeBaseId=${config.id}`}
	                                            className="flex-1 bg-white border border-blue-200 rounded-lg px-3 py-2 text-xs font-mono text-gray-700 cursor-pointer"
	                                            onClick={(e) => e.target.select()}
	                                        />
                                                <button
                                                    onClick={() => {
                                                        navigator.clipboard.writeText(`${window.location.origin}/static/chat.html?knowledgeBaseId=${config.id}`);
                                                        notify('Link copied', 'Share chat link is in your clipboard.', 'success');
                                                    }}
                                            className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700 transition-colors flex items-center gap-1"
                                        >
                                            <Icon name="copy" size={14} />
                                            Copy
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => window.open(`/static/chat.html?knowledgeBaseId=${config.id}`, '_blank')}
                                        className="w-full bg-white border border-blue-300 text-blue-700 py-2 rounded-lg text-xs font-medium hover:bg-blue-100 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Icon name="external-link" size={14} />
                                        Open Chat Page
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-gray-200 bg-white sticky bottom-0">
                            <button onClick={saveConfig} className="w-full bg-gray-900 text-white py-3 rounded-xl flex justify-center items-center gap-2 hover:bg-black transition-colors">
                                <Icon name="save" size={18} /> Save Config
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 bg-gray-50 p-8 relative overflow-y-auto">
                        <div className="max-w-4xl mx-auto">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-900">Knowledge Base</h2>
                                        <span className="text-xs text-gray-500 bg-gray-100 rounded px-2 py-1">{config.id ? `Knowledge Base ID: ${config.id}` : "Save knowledge base to generate ID"}</span>
                                        <label className={`bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all shadow-sm ${(!config.id || loading) ? 'opacity-60 cursor-not-allowed' : 'hover:bg-blue-700 cursor-pointer'}`}>
                                    <Icon name="upload-cloud" size={18} />
                                    {loading ? "Processing..." : "Upload Document"}
                                    <input type="file" className="hidden" accept={acceptedFileTypes} onChange={uploadFile} disabled={loading || !config.id} />
                                </label>
                                    </div>
                                    <p className="text-xs text-gray-500 mb-4">Supported formats: {supportedFormats.join(', ')}. Max size: {maxUploadMb} MB.</p>
                            {error && <div className="mb-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-4 py-3">{error}</div>}
                            {uploadMessage && <div className="mb-4 text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg px-4 py-3">{uploadMessage}</div>}

                            {docs.length === 0 ? (
                                <div className="bg-white border-2 border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-400">
                                    <div className="mx-auto w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"><Icon name="file" size={24} /></div>
                                    <p>No documents found. Upload a supported document to start.</p>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100">
                                    {docs.map(doc => (
                                        <div key={doc.id} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 bg-red-50 text-red-500 rounded-lg flex items-center justify-center"><Icon name="file-text" size={20} /></div>
                                                <div>
                                                    <p className="font-medium text-gray-900">{doc.filename}</p>
                                                    <p className="text-xs text-gray-500">Indexed {new Date(doc.created_at || Date.now()).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => openEditor(doc.id)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg tooltip" title="Edit Text">
                                                    <Icon name="edit-3" size={18} />
                                                </button>
                                                <button onClick={() => reindexDoc(doc.id)} className="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg tooltip" title="Reindex">
                                                    <Icon name="refresh-cw" size={18} />
                                                </button>
                                                <button onClick={() => deleteDoc(doc.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg tooltip" title="Delete">
                                                    <Icon name="trash-2" size={18} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Floating Chat Button */}
                        <div className="fixed bottom-8 right-8 z-50">
                            <button onClick={() => setShowChat(!showChat)} className="w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-105 transition-transform">
                                {showChat ? <Icon name="x" size={24} /> : <Icon name="message-circle" size={28} />}
                            </button>
                        </div>

                        {/* Chat Box */}
                        {showChat && (
                            <div
                                className="fixed bottom-24 right-8 bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col z-40 overflow-hidden animate-in slide-in-from-bottom-5"
                                style={{
                                    width: isMaximized ? '100vw' : chatSize.width,
                                    height: isMaximized ? '100vh' : chatSize.height,
                                    minWidth: minChatSize.width,
                                    minHeight: minChatSize.height,
                                    left: isMaximized ? 0 : 'auto',
                                    right: isMaximized ? 0 : '32px',
                                    bottom: isMaximized ? 0 : '96px',
                                    top: isMaximized ? 0 : 'auto',
                                    borderRadius: isMaximized ? 0 : undefined
                                }}
                            >
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <div className="flex flex-col leading-tight">
                                            <span className="font-medium">{config.name}</span>
                                            <span className="text-[10px] text-white/70">ID: {config.id || "Not saved"}</span>
                                        </div>
                                    </div>
                                    <button
                                        onClick={toggleMaximize}
                                        className="text-white/80 hover:text-white transition-colors"
                                        title={isMaximized ? "Restore" : "Maximize"}
                                    >
                                        <Icon name={isMaximized ? "minimize-2" : "maximize-2"} size={18} />
                                    </button>
                                </div>
                                <ChatBox knowledgeBase={config} userApiKey={apiKey} />
                                {!isMaximized && (
                                    <div
                                        className="absolute bottom-2 right-2 w-4 h-4 bg-gray-200 border border-gray-300 rounded cursor-se-resize flex items-center justify-center text-gray-500"
                                        onMouseDown={startChatResize}
                                        title="Drag to resize"
                                    >
                                        <Icon name="move" size={12} />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Editor Modal */}
                    {editorOpen && editDocData && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold text-gray-800">Edit extracted text</h3>
                                    <button onClick={() => setEditorOpen(false)} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={24} /></button>
                                </div>
                                <div className="flex-1">
                                    <textarea className="w-full h-full p-6 outline-none font-mono text-sm leading-relaxed text-gray-700 resize-none"
                                        value={editDocData.text}
                                        onChange={e => setEditDocData({ ...editDocData, text: e.target.value })}
                                    ></textarea>
                                </div>
                                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                                    <button onClick={() => setEditorOpen(false)} className="px-5 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Cancel</button>
                                    <button onClick={saveEditedText} className="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md">Save Changes & Re-Index</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Credential Management Modal */}
                    {showCredentialModal && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-3xl max-h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-6 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-blue-50 to-indigo-50">
                                    <div>
                                        <h3 className="font-bold text-xl text-gray-900">Manage Allowed Users</h3>
                                        <p className="text-sm text-gray-600 mt-1">Add or remove users who can access this knowledge base</p>
                                    </div>
                                    <button onClick={() => { setShowCredentialModal(false); setCredentialPage(0); }} className="text-gray-400 hover:text-gray-600">
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>

                                {/* Add New Credential Form */}
                                <div className="p-6 border-b border-gray-200 bg-gray-50">
                                    <div className="flex gap-3">
                                        <div className="flex-1">
                                            <label className="block text-xs font-semibold text-gray-600 mb-2">Email Address</label>
                                            <input
                                                className="w-full bg-white border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                placeholder="user@example.com"
                                                type="email"
                                                value={newCredential.email}
                                                onChange={e => setNewCredential({ ...newCredential, email: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-semibold text-gray-600 mb-2">Password</label>
                                            <input
                                                className="w-full bg-white border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                placeholder="Enter password"
                                                type="password"
                                                value={newCredential.password}
                                                onChange={e => setNewCredential({ ...newCredential, password: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex items-end">
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    addCredential();
                                                    setCredentialPage(0);
                                                }}
                                                className="px-6 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm"
                                            >
                                                <Icon name="plus" size={16} />
                                                Add User
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Credentials List */}
                                <div className="flex-1 overflow-y-auto p-6">
                                    {(config.credentials || []).length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <Icon name="users" size={32} className="text-gray-400" />
                                            </div>
                                            <p className="text-gray-500 text-sm">No users added yet</p>
                                            <p className="text-gray-400 text-xs mt-1">Add email/password pairs above to grant access</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="space-y-2">
                                                {(config.credentials || [])
                                                    .slice(credentialPage * credentialsPerPage, (credentialPage + 1) * credentialsPerPage)
                                                    .map((cred, idx) => {
                                                        const actualIdx = credentialPage * credentialsPerPage + idx;
                                                        return (
                                                            <div key={actualIdx} className="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-4 py-3 hover:border-blue-300 hover:shadow-sm transition-all group">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-semibold">
                                                                        {cred.email.charAt(0).toUpperCase()}
                                                                    </div>
                                                                    <div>
                                                                        <p className="text-sm font-medium text-gray-900">{cred.email}</p>
                                                                        <p className="text-xs text-gray-500">Password: {''.repeat(8)}</p>
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => removeCredential(actualIdx)}
                                                                    className="px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-xs font-medium transition-colors flex items-center gap-1 opacity-0 group-hover:opacity-100"
                                                                >
                                                                    <Icon name="trash-2" size={14} />
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        );
                                                    })
                                                }
                                            </div>

                                            {/* Pagination */}
                                            {(config.credentials || []).length > credentialsPerPage && (
                                                <div className="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                                                    <div className="text-sm text-gray-600">
                                                        Showing {credentialPage * credentialsPerPage + 1} - {Math.min((credentialPage + 1) * credentialsPerPage, (config.credentials || []).length)} of {(config.credentials || []).length} users
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => setCredentialPage(Math.max(0, credentialPage - 1))}
                                                            disabled={credentialPage === 0}
                                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
                                                        >
                                                            <Icon name="chevron-left" size={16} />
                                                        </button>
                                                        <button
                                                            onClick={() => setCredentialPage(Math.min(Math.ceil((config.credentials || []).length / credentialsPerPage) - 1, credentialPage + 1))}
                                                            disabled={(credentialPage + 1) * credentialsPerPage >= (config.credentials || []).length}
                                                            className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
                                                        >
                                                            <Icon name="chevron-right" size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                                    <p className="text-xs text-gray-500">
                                        <Icon name="info" size={14} className="inline mr-1" />
                                        Click "Save & Close" to persist changes
                                    </p>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => { setShowCredentialModal(false); setCredentialPage(0); }}
                                            className="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={async () => {
                                                setShowCredentialModal(false);
                                                setCredentialPage(0);
                                                await saveConfig();
                                            }}
                                            className="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2"
                                        >
                                            <Icon name="save" size={16} />
                                            Save & Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- CHAT BOX COMPONENT ---
        const ChatBox = ({ knowledgeBase, userApiKey }) => {
            const knowledgeBaseId = knowledgeBase?.id;
            const [msgs, setMsgs] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [auth, setAuth] = useState({ email: "", password: "", apiKey: userApiKey || "" });
            const scrollRef = useRef(null);

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [msgs]);

            useEffect(() => {
                setMsgs([]);
                setAuth({ email: "", password: "", apiKey: userApiKey || "" });
            }, [knowledgeBaseId]);

            useEffect(() => {
                setAuth(prev => ({ ...prev, apiKey: userApiKey || prev.apiKey }));
            }, [userApiKey]);

            const send = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const newMsgs = [...msgs, { role: 'user', content: input }];
                setMsgs(newMsgs);
                setInput("");
                setLoading(true);

	                if (!knowledgeBaseId) {
	                    setMsgs([...newMsgs, { role: 'model', content: "Please save the knowledge base before starting a chat." }]);
	                    setLoading(false);
	                    return;
	                }

	                if (knowledgeBase?.secure_enabled && !auth.apiKey && (!auth.email || !auth.password)) {
	                    setMsgs([...newMsgs, { role: 'model', content: "Provide API key or email/password to chat with this secure knowledge base." }]);
	                    setLoading(false);
	                    return;
	                }

                try {
                    const historyPayload = newMsgs.map(m => ({
                        role: m.role === 'model' ? 'assistant' : 'user',
                        content: m.content
                    }));
	                    const headers = { 'Content-Type': 'application/json' };
                    if (userApiKey) headers['Authorization'] = `Bearer ${userApiKey}`;
	                    const res = await fetch(getApiUrl('/api/chat'), {
	                        method: 'POST',
	                        headers,
	                        body: JSON.stringify({
	                            assistant_id: knowledgeBaseId,
	                            knowledge_base_id: knowledgeBaseId,
	                            query: newMsgs[newMsgs.length - 1].content,
	                            history: historyPayload,
	                            email: auth.email || undefined,
	                            password: auth.password || undefined,
	                            api_key: auth.apiKey || userApiKey || undefined
	                        })
	                    });
                    const data = await res.json();
                    if (!res.ok) {
                        const message = data?.detail || "Chat request failed";
                        setMsgs([...newMsgs, { role: 'model', content: message }]);
                        setLoading(false);
                        return;
                    }
                    setMsgs([...newMsgs, { role: 'model', content: data.answer, sources: data.sources, contexts: data.contexts }]);
                } catch (e) {
                    setMsgs([...newMsgs, { role: 'model', content: "Error connecting to backend." }]);
                }
                setLoading(false);
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
	                        {knowledgeBase?.secure_enabled && (
	                            <div className="text-[11px] text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
	                                Secure knowledge base. Use API key or email/password to chat.
	                            </div>
	                        )}
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none shadow-sm'}`}>
                                    <p className="whitespace-pre-wrap">{m.content}</p>
                                    {m.sources && m.sources.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-gray-100 text-[10px] opacity-70">
                                            Sources: {m.sources.join(", ")}
                                        </div>
                                    )}
                                    {m.contexts && m.contexts.length > 0 && (
                                        <details className="mt-3 group">
                                            <summary className="cursor-pointer text-xs font-semibold text-gray-700 flex items-center gap-2 select-none">
                                                <Icon name="folder-open" size={14} />
                                                View retrieved context ({m.contexts.length})
                                            </summary>
                                            <div className="mt-2 space-y-2">
                                                {m.contexts.map((ctx, idx) => (
                                                    <div key={idx} className="p-3 border border-gray-100 rounded-lg bg-gray-50">
                                                        <div className="flex justify-between items-center text-[11px] text-gray-500 mb-1">
                                                            <span className="font-medium">{ctx.filename || `Context ${idx + 1}`}</span>
                                                            <span>Score: {typeof ctx.score === "number" ? ctx.score.toFixed(3) : ""}</span>
                                                        </div>
                                                        <p className="text-xs text-gray-700 whitespace-pre-wrap leading-relaxed">{ctx.text}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </details>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-center text-gray-400">Thinking...</div>}
                        <div ref={scrollRef}></div>
                    </div>
                    <form onSubmit={send} className="p-3 bg-white border-t border-gray-100 flex flex-col gap-2">
                        {knowledgeBase?.secure_enabled && (
                            <div className="flex gap-2">
                                <input className="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-xs outline-none" placeholder="API Key" value={auth.apiKey} onChange={e => setAuth({ ...auth, apiKey: e.target.value })} />
                                <input className="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-xs outline-none" placeholder="Email" value={auth.email} onChange={e => setAuth({ ...auth, email: e.target.value })} />
                                <input className="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-xs outline-none" placeholder="Password" type="password" value={auth.password} onChange={e => setAuth({ ...auth, password: e.target.value })} />
                            </div>
                        )}
                        <div className="flex gap-2">
                            <input className="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                                placeholder="Type a message..." value={input} onChange={e => setInput(e.target.value)} />
                            <button disabled={loading} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"><Icon name="send" size={16} /></button>
                        </div>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
